<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>ESP32 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial;max-width:900px;margin:20px auto;}
    .tile{display:inline-block;width:180px;padding:10px;margin:5px;background:#f7f7f7;border-radius:10px;text-align:center;}
    .chart-box{background:#fff;padding:15px;margin:20px 0;border-radius:10px;box-shadow:0 0 5px rgba(0,0,0,0.1);}
    #status{margin:10px;font-weight:bold;}
  </style>
</head>
<body>
  <h2>🌱 ESP32 Real-time Dashboard by Naphat</h2>
  <div id="status">⚠️ WS Status: Disconnected</div>
  <input id="wsUrl" value="ws://192.168.4.1:81" style="width:300px">
  <button onclick="connectWS()">Connect</button>

  <div>
    <div class="tile"><b>🌡 Temp</b><div id="temp">--</div></div>
    <div class="tile"><b>💧 Humidity</b><div id="hum">--</div></div>
    <div class="tile"><b>🌞 Light</b><div id="light">--</div></div>
    <div class="tile"><b>🌱 Soil</b><div id="soil">--</div></div>
    <div class="tile"><b>💦 Pump</b><div id="pump">--</div></div>
  </div>

  <div class="chart-box">
    <h3>🌡 Temperature (°C)</h3>
    <canvas id="tempChart" height="100"></canvas>
  </div>
  <div class="chart-box">
    <h3>💧 Humidity (%)</h3>
    <canvas id="humChart" height="100"></canvas>
  </div>
  <div class="chart-box">
    <h3>🌞 Light</h3>
    <canvas id="lightChart" height="100"></canvas>
  </div>
  <div class="chart-box">
    <h3>🌱 Soil Moisture (%)</h3>
    <canvas id="soilChart" height="100"></canvas>
  </div>

<script>
let ws;
let reconnectTimer;

function makeChart(ctx,label,min=0,max=100,color="blue"){
  return new Chart(ctx,{
    type:"line",
    data:{labels:[],datasets:[{label:label,data:[],borderColor:color,fill:false}]},
    options:{scales:{y:{min:min,max:max}}}
  });
}
let tempChart   = makeChart(document.getElementById("tempChart"),"Temp °C",0,50,"red");
let humChart    = makeChart(document.getElementById("humChart"),"Humidity %",0,100,"blue");
let lightChart  = makeChart(document.getElementById("lightChart"),"Light",0,4095,"orange");
let soilChart   = makeChart(document.getElementById("soilChart"),"Soil %",0,100,"green");

function updateChart(chart,value){
  let t = new Date().toLocaleTimeString();
  chart.data.labels.push(t);
  chart.data.datasets[0].data.push(value);
  if(chart.data.labels.length>30){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

function connectWS(){
  const url = document.getElementById("wsUrl").value;
  if (!url) { alert('ใส่ ws://<ESP_IP>:81 ก่อน'); return; }

  if(ws) ws.close(); // ปิด connection เก่า

  ws = new WebSocket(url);

  ws.onopen = ()=>{
    console.log("✅ WS Connected");
    document.getElementById("status").innerText = "✅ WS Status: Connected";
    document.getElementById("status").style.color = "green";
    if(reconnectTimer) clearTimeout(reconnectTimer);
  };

  ws.onmessage = (evt) => {
    try {
      const obj = JSON.parse(evt.data);
      document.getElementById("temp").innerText = obj.temp + " °C";
      document.getElementById("hum").innerText = obj.hum + " %";
      document.getElementById("light").innerText = obj.light;
      document.getElementById("soil").innerText = obj.soilPercent + " %";
      document.getElementById("pump").innerText = obj.pump;

      updateChart(tempChart, obj.temp);
      updateChart(humChart, obj.hum);
      updateChart(lightChart, obj.light);
      updateChart(soilChart, obj.soilPercent);
    } catch(e) {
      console.error("Invalid JSON", e, evt.data);
    }
  };

  ws.onclose = ()=>{
    console.log("❌ WS Closed");
    document.getElementById("status").innerText = "❌ WS Status: Disconnected";
    document.getElementById("status").style.color = "red";
    reconnectTimer = setTimeout(connectWS, 3000); // 🔄 auto reconnect 3 วิ
  };

  ws.onerror = (e)=>{
    console.error("⚠️ WS Error", e);
    document.getElementById("status").innerText = "⚠️ WS Status: Error";
    document.getElementById("status").style.color = "orange";
    ws.close();
  };
}
</script>
</body>
</html>
